<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√°lculo de Frete ANTT 6.067/2025</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b1020; color: #e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .card { background: #111a33; border: 1px solid #22305e; border-radius: 14px; padding: 16px; }
    h1 { margin: 0 0 10px; font-size: 20px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 860px){ .grid { grid-template-columns: 1.1fr 0.9fr; } }
    label { display:block; font-size: 12px; opacity: .9; margin: 10px 0 6px; }
    input, select {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #2b3a72; background: #0d1430; color: #e9eefc;
      outline: none;
    }
    input:focus, select:focus { border-color: #5b7cfa; box-shadow: 0 0 0 3px rgba(91,124,250,.25); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 14px; }
    .k { background:#0d1430; border:1px solid #2b3a72; border-radius: 12px; padding: 12px; }
    .k .t { font-size: 12px; opacity: .85; }
    .k .v { font-size: 18px; font-weight: 700; margin-top: 6px; }
    .muted { opacity: .75; font-size: 12px; margin-top: 8px; }
    .btn {
      margin-top: 12px; width: 100%; padding: 10px 12px; border-radius: 12px;
      border: 1px solid #3a53a8; background: #1b2a5a; color: #e9eefc; cursor:pointer;
      font-weight: 700;
    }
    .btn:hover { filter: brightness(1.08); }
    .pill { display:inline-block; font-size: 12px; padding: 4px 10px; border-radius: 999px;
      background: rgba(91,124,250,.18); border: 1px solid rgba(91,124,250,.35);
    }

    /* tabela */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #1f2b55; font-size: 13px; }
    th { font-size: 12px; text-transform: uppercase; letter-spacing: .04em; opacity: .9; background: #0d1430; position: sticky; top: 0; }
    td.num, th.num { text-align: right; }
    tr.rowItem { cursor: pointer; }
    tr.rowItem:hover { background: rgba(91,124,250,.10); }
    tr.active { background: rgba(91,124,250,.16); }
    .motorCol { color: #ffb3b3; font-weight: 700; }
    .empresaCol { color: #b7d4ff; font-weight: 700; }

    /* inputs da tabela de peso */
    .pesoInput {
      max-width: 120px;
      text-align: right;
      padding: 8px 10px;
      border-radius: 10px;
    }

    /* ====== BLOQUEIO SIMPLES (login) ====== */
    .lock {
      position: fixed; inset: 0;
      background: rgba(11,16,32,.92);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
    }
    .lock.show { display: flex; }
    .lockCard {
      width: min(520px, 100%);
      background: #111a33;
      border: 1px solid #22305e;
      border-radius: 16px;
      padding: 18px;
    }
    .lockTitle { font-size: 18px; font-weight: 800; margin: 0 0 8px; }
    .lockRow { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
    .lockHint { font-size: 12px; opacity: .8; margin-top: 8px; }
    .topbar {
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .smallBtn {
      padding: 8px 10px; border-radius: 12px;
      border: 1px solid #3a53a8; background: #1b2a5a; color: #e9eefc; cursor:pointer;
      font-weight: 700; font-size: 12px;
    }
    .smallBtn:hover { filter: brightness(1.08); }
  </style>
</head>
<body>

  <!-- TELA DE SENHA -->
  <div class="lock" id="lock">
    <div class="lockCard">
      <p class="lockTitle">üîí Acesso restrito</p>
      <div class="muted">Digite a senha para acessar o c√°lculo.</div>

      <div class="lockRow">
        <label for="lockPass">Senha</label>
        <input id="lockPass" type="password" placeholder="Senha da equipe" />
        <button class="btn" id="lockBtn">Entrar</button>
        <div class="muted" id="lockMsg" style="color:#ffb3b3; display:none;">Senha incorreta.</div>
      </div>

      <div class="lockHint">Acesso somente para Nova Frota</div>
    </div>
  </div>

  <div class="wrap" id="app">
    <div class="card">
      <div class="topbar">
        <div>
          <h1>üöö C√°lculo de Frete ANTT 6.067/2025 NOVA FROTA TRANSPORTES E LOGISTICA LTDA</h1>
          <div class="muted">Site simples Nova Frota.</div>
        </div>
        <button class="smallBtn" id="btnLogout">Sair</button>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <div class="card">
        <div class="pill">Entrada</div>

        <label for="tipo">Tipo</label>
        <select id="tipo"></select>

        <div class="row">
          <div>
            <label for="km">KM total</label>
            <input id="km" type="number" step="0.1" value="127" />
          </div>
          <div>
            <label for="pedagio">Ped√°gio por eixo (R$)</label>
            <input id="pedagio" type="number" step="0.01" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="margem">Margem (%)</label>
            <input id="margem" type="number" step="0.01" value="5" />
          </div>
          <div>
            <label for="icms">ICMS (%) (opcional)</label>
            <input id="icms" type="number" step="0.01" value="0" />
          </div>
        </div>

        <button class="btn" id="btnCalc">Calcular</button>

        <div class="kpi">
          <div class="k">
            <div class="t">Frete Motorista (R$)</div>
            <div class="v" id="outMotorista">-</div>
          </div>
          <div class="k">
            <div class="t">Frete Empresa (R$)</div>
            <div class="v" id="outEmpresa">-</div>
          </div>
        </div>

        <div class="muted">
          <b>Motorista:</b> ARREDONDAR.PARA.CIMA(((R$/KM√óKM)+CustoCC+(Ped√°gio/Eixo√óEixos))/Peso;0)<br/>
          <b>Empresa:</b> Motorista/(1-Margem)/(1-ICMS) <span style="opacity:.9">(sem arredondar)</span>
        </div>
      </div>

      <div class="card">
        <div class="pill">Tabela de Fretes (por tipo)</div>

        <div style="overflow:auto; margin-top:10px; border:1px solid #2b3a72; border-radius:12px; max-height: 320px;">
          <table>
            <thead>
              <tr>
                <th>Tipo</th>
                <th class="num">Frete Motorista</th>
                <th class="num">Frete Empresa</th>
                <th class="num">Eixos</th>
              </tr>
            </thead>
            <tbody id="tblFretes"></tbody>
          </table>
        </div>

        <div class="pill" style="margin-top:12px;">Peso m√©dio (edit√°vel)</div>

        <div style="overflow:auto; margin-top:10px; border:1px solid #2b3a72; border-radius:12px; max-height: 260px;">
          <table>
            <thead>
              <tr>
                <th>Tipo</th>
                <th class="num">Peso m√©dio</th>
              </tr>
            </thead>
            <tbody id="tblPesos"></tbody>
          </table>
        </div>

        <div class="muted">
          Os pesos alterados ficam salvos neste navegador. Para voltar ao padr√£o:
          <div style="margin-top:8px;">
            <button class="btn" id="btnResetPesos" style="margin-top:0;">Resetar pesos</button>
          </div>
        </div>

        <div class="pill" style="margin-top:14px;">Dados do Tipo selecionado</div>

        <div class="kpi">
          <div class="k">
            <div class="t">R$ / KM</div>
            <div class="v" id="outRkm">-</div>
          </div>
          <div class="k">
            <div class="t">Custo CC</div>
            <div class="v" id="outCC">-</div>
          </div>
          <div class="k">
            <div class="t">Peso m√©dio (usado)</div>
            <div class="v" id="outPeso">-</div>
          </div>
          <div class="k">
            <div class="t">Observa√ß√£o</div>
            <div class="v" style="font-size:14px; font-weight:600" id="outObs">-</div>
          </div>
        </div>

        <div class="muted">
          Clique em uma linha da tabela para selecionar o tipo.
        </div>
      </div>
    </div>
  </div>

<script>
/* ================== BLOQUEIO SIMPLES ==================
   Troque a senha aqui embaixo.
   (isso √© s√≥ um bloqueio b√°sico para equipe, n√£o √© seguran√ßa forte)
*/
const TEAM_PASSWORD = "2026"; // <<< TROQUE AQUI
const AUTH_KEY = "antt_auth_ok_v1";

function isAuthed(){ return localStorage.getItem(AUTH_KEY) === "1"; }
function setAuthed(v){ localStorage.setItem(AUTH_KEY, v ? "1" : "0"); }

function showLock(show){
  const lock = document.getElementById("lock");
  const app = document.getElementById("app");
  if (show){
    lock.classList.add("show");
    app.style.display = "none";
    const pass = document.getElementById("lockPass");
    pass.value = "";
    pass.focus();
  } else {
    lock.classList.remove("show");
    app.style.display = "";
  }
}

function initAuth(){
  if (!isAuthed()) showLock(true);
  else showLock(false);

  const btn = document.getElementById("lockBtn");
  const pass = document.getElementById("lockPass");
  const msg = document.getElementById("lockMsg");

  function tryLogin(){
    const ok = pass.value === TEAM_PASSWORD;
    msg.style.display = ok ? "none" : "block";
    if (ok){
      setAuthed(true);
      showLock(false);
      calc();
    }
  }

  btn.addEventListener("click", tryLogin);
  pass.addEventListener("keydown", (e) => {
    if (e.key === "Enter") tryLogin();
  });

  const logout = document.getElementById("btnLogout");
  logout.addEventListener("click", () => {
    setAuthed(false);
    showLock(true);
  });
}

/* ================== APP ================== */
const DATA = [
  { tipo: "9 Rodotrem",        rkm: 8.53,   custoCC: 877.83, peso: 49 },
  { tipo: "9 Rodoca√ßamba",     rkm: 8.53,   custoCC: 877.83, peso: 47 },
  { tipo: "8 eixos Graneleiro",rkm: 7.4505, custoCC: 792.30, peso: 45 },
  { tipo: "8 eixos Ca√ßamba",   rkm: 7.4505, custoCC: 792.30, peso: 43 },
  { tipo: "4¬∫ eixo Graneleiro",rkm: 7.4505, custoCC: 792.30, peso: 39 },
  { tipo: "4¬∫ eixo Ca√ßamba",   rkm: 7.4505, custoCC: 792.30, peso: 37 },
  { tipo: "7 Bitrem",          rkm: 7.4505, custoCC: 792.30, peso: 37 },
  { tipo: "7 Bi√ßamba",         rkm: 7.4505, custoCC: 792.30, peso: 35 },
  { tipo: "6 LS Graneleiro",   rkm: 6.8058, custoCC: 656.76, peso: 31 },
  { tipo: "6 LS Ca√ßamba",      rkm: 6.8058, custoCC: 656.76, peso: 29 },
  { tipo: "5 LS Graneleiro",   rkm: 6.1859, custoCC: 642.10, peso: 26 },
  { tipo: "5 LS TOCO Ca√ßamba", rkm: 6.1859, custoCC: 642.10, peso: 25 },
];

const $ = (id) => document.getElementById(id);
const money = (n) => n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
const numpt = (n, d=4) => n.toLocaleString("pt-BR", { minimumFractionDigits: d, maximumFractionDigits: d });

function fillTipos(){
  const sel = $("tipo");
  sel.innerHTML = "";
  DATA.forEach((r, idx) => {
    const op = document.createElement("option");
    op.value = idx;
    op.textContent = r.tipo;
    sel.appendChild(op);
  });
  sel.value = "0";
}

function extrairEixos(tipo){
  const m = String(tipo).trim().match(/^(\d+)/);
  return m ? Number(m[1]) : 0;
}

function ceil0(n){
  return Math.ceil(n);
}

/* ====== PESO EDIT√ÅVEL (salvo no navegador) ====== */
const PESOS_KEY = "antt_pesos_custom_v1";

function loadPesosCustom(){
  try {
    const raw = localStorage.getItem(PESOS_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === "object") ? obj : {};
  } catch (e) {
    return {};
  }
}

function savePesosCustom(obj){
  localStorage.setItem(PESOS_KEY, JSON.stringify(obj));
}

let pesosCustom = loadPesosCustom();

function getPeso(row){
  const v = pesosCustom[row.tipo];
  const n = Number(v);
  return (Number.isFinite(n) && n > 0) ? n : row.peso;
}

function renderTabelaPesos(){
  const tbody = $("tblPesos");
  if (!tbody) return;
  tbody.innerHTML = "";

  const idxSel = Number($("tipo").value);

  DATA.forEach((row, idx) => {
    const tr = document.createElement("tr");
    tr.className = "rowItem" + (idx === idxSel ? " active" : "");

    const pesoAtual = getPeso(row);

    tr.innerHTML = `
      <td style="white-space:nowrap">${row.tipo}</td>
      <td class="num">
        <input
          class="pesoInput"
          data-tipo="${row.tipo}"
          type="number"
          step="1"
          min="1"
          value="${pesoAtual}"
        />
      </td>
    `;

    const input = tr.querySelector("input[data-tipo]");
    input.addEventListener("input", (ev) => {
      const tipo = ev.target.getAttribute("data-tipo");
      const val = Number(ev.target.value);

      if (Number.isFinite(val) && val > 0) {
        pesosCustom[tipo] = val;
      } else {
        delete pesosCustom[tipo];
      }

      savePesosCustom(pesosCustom);
      calc();
    });

    tbody.appendChild(tr);
  });
}

function resetPesos(){
  pesosCustom = {};
  localStorage.removeItem(PESOS_KEY);
  calc();
}

/**
 * ‚úÖ REGRA:
 * Motorista = ceil( ((rkm*km) + custoCC + (pedagioPorEixo*eixos)) / peso )
 * Empresa   = Motorista / (1-margem) / (1-icms)   // sem arredondar
 */
function calcFretes(row, km, pedagioPorEixo, margem, icms){
  const eixos = extrairEixos(row.tipo);

  const numerador = (row.rkm * km) + row.custoCC + (pedagioPorEixo * eixos);

  const pesoUsado = getPeso(row);
  const base = numerador / pesoUsado;

  const freteMotorista = ceil0(base);

  const denomMargem = (1 - margem);
  const denomIcms = (1 - icms);

  const freteEmpresa =
    (denomMargem <= 0 || denomIcms <= 0)
      ? NaN
      : (freteMotorista / denomMargem / denomIcms);

  return { eixos, pesoUsado, freteMotorista, freteEmpresa };
}

function renderTabela(km, pedagioPorEixo, margem, icms){
  const tbody = $("tblFretes");
  tbody.innerHTML = "";

  const idxSel = Number($("tipo").value);

  DATA.forEach((row, idx) => {
    const r = calcFretes(row, km, pedagioPorEixo, margem, icms);

    const tr = document.createElement("tr");
    tr.className = "rowItem" + (idx === idxSel ? " active" : "");

    tr.innerHTML = `
      <td style="white-space:nowrap">${row.tipo}</td>
      <td class="num motorCol">${money(r.freteMotorista)}</td>
      <td class="num empresaCol">${Number.isFinite(r.freteEmpresa) ? money(r.freteEmpresa) : "Erro"}</td>
      <td class="num" style="opacity:.85">${r.eixos}</td>
    `;

    tr.addEventListener("click", () => {
      $("tipo").value = String(idx);
      calc();
    });

    tbody.appendChild(tr);
  });
}

function calc(){
  if (!isAuthed()) return;

  const row = DATA[Number($("tipo").value)];
  const km = Number($("km").value || 0);
  const pedagioPorEixo = Number($("pedagio").value || 0);

  const margem = Number($("margem").value || 0) / 100;
  const icms = Number($("icms").value || 0) / 100;

  const { eixos, pesoUsado, freteMotorista, freteEmpresa } = calcFretes(row, km, pedagioPorEixo, margem, icms);

  $("outRkm").textContent = "R$ " + numpt(row.rkm, 4);
  $("outCC").textContent = "R$ " + numpt(row.custoCC, 3);
  $("outPeso").textContent = pesoUsado.toLocaleString("pt-BR");
  $("outObs").textContent = `${row.tipo} | Eixos: ${eixos}`;

  $("outMotorista").textContent = money(freteMotorista);
  $("outEmpresa").textContent = Number.isFinite(freteEmpresa) ? money(freteEmpresa) : "Erro (margem/ICMS 100%)";

  renderTabela(km, pedagioPorEixo, margem, icms);
  renderTabelaPesos();
}

/* init */
initAuth();
fillTipos();

const btnReset = $("btnResetPesos");
if (btnReset) btnReset.addEventListener("click", resetPesos);

$("btnCalc").addEventListener("click", calc);
$("tipo").addEventListener("change", calc);
["km","pedagio","margem","icms"].forEach(id => $(id).addEventListener("input", calc));

if (isAuthed()) calc();
</script>
</body>
</html>
