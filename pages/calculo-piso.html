<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√°lculo de Frete ANTT 6.067/2025</title>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- ‚úÖ ADICIONADO: trava do LOGIN 1 (HOME) -->
  <!-- IMPORTANTE: como este arquivo fica em /pages, o caminho √© ../assets/js/auth.js -->
  <script src="../assets/js/auth.js"></script>
  <script>
    // Exige que o usu√°rio tenha passado pelo Login 1 do sistema
    requireHomeAuth();
  </script>

  <style>
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --bg:#0b1020; --cardBorder:rgba(34,48,94,.9);
      --ink:#e9eefc; --muted:rgba(233,238,252,.72);
      --blue:#5b7cfa; --neon:rgba(60,255,160,.70);
      --neonSoft:rgba(60,255,160,.18); --neonBorder:rgba(60,255,160,.45);
    }
    *,*::before,*::after{box-sizing:border-box}
    body{
      margin:0;color:var(--ink);
      background: radial-gradient(1200px 700px at 20% 15%, rgba(91,124,250,.18), transparent 55%),
                  radial-gradient(900px 600px at 85% 10%, rgba(60,255,160,.10), transparent 55%),
                  radial-gradient(1200px 700px at 50% 120%, rgba(120,80,255,.12), transparent 60%),
                  var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .card{
      background:linear-gradient(180deg, rgba(17,26,51,.86), rgba(13,20,48,.78));
      border:1px solid var(--cardBorder);border-radius:16px;padding:16px;
      backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,.25);
      position:relative;overflow:hidden;
    }
    .card::before{
      content:"";position:absolute;left:-20%;top:-40px;width:140%;height:80px;
      background:radial-gradient(closest-side, rgba(91,124,250,.20), transparent 70%);
      opacity:.65;pointer-events:none;
    }
    h1{margin:0 0 8px;font-size:20px;letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
    label{display:block;font-size:12px;opacity:.92;margin:10px 0 6px}
    input,select{
      width:100%;max-width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid rgba(43,58,114,.95);background:rgba(13,20,48,.92);
      color:var(--ink);outline:none;transition:box-shadow .18s,border-color .18s,transform .08s;
    }
    input:focus,select:focus{border-color:rgba(91,124,250,.95);box-shadow:0 0 0 3px rgba(91,124,250,.25)}
    .editingGlow{
      border-color:var(--neonBorder)!important;
      box-shadow:0 0 0 3px rgba(60,255,160,.18), 0 0 26px rgba(60,255,160,.14)!important;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    .k{
      background:rgba(13,20,48,.92);border:1px solid rgba(43,58,114,.95);
      border-radius:14px;padding:12px;position:relative;overflow:hidden;
    }
    .k::after{
      content:"";position:absolute;inset:-40% -40% auto -40%;height:110px;
      background:radial-gradient(closest-side, rgba(60,255,160,.12), transparent 70%);
      opacity:.55;pointer-events:none;
    }
    .k .t{font-size:12px;opacity:.85}
    .k .v{font-size:18px;font-weight:800;margin-top:6px}
    .muted{opacity:.78;font-size:12px;margin-top:8px;color:var(--muted)}
    .btn{
      margin-top:12px;width:100%;padding:10px 12px;border-radius:14px;
      border:1px solid rgba(58,83,168,.95);
      background:linear-gradient(180deg, rgba(27,42,90,.95), rgba(18,30,70,.95));
      color:var(--ink);cursor:pointer;font-weight:800;letter-spacing:.2px;
      transition:transform .08s, filter .15s;
    }
    .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
    .pill{
      display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;
      background:rgba(91,124,250,.16);border:1px solid rgba(91,124,250,.35);
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(31,43,85,.85);font-size:13px}
    th{
      font-size:12px;text-transform:uppercase;letter-spacing:.04em;opacity:.92;
      background:rgba(13,20,48,.96);position:sticky;top:0;z-index:1;
    }
    td.num,th.num{text-align:right}
    tr.rowItem{cursor:pointer} tr.rowItem:hover{background:rgba(91,124,250,.10)}
    tr.active{background:rgba(91,124,250,.16)}
    .motorCol{color:#ffb3b3;font-weight:800} .empresaCol{color:#b7d4ff;font-weight:800}
    .pesoInput{max-width:160px;text-align:right;padding:8px 10px;border-radius:12px;font-variant-numeric:tabular-nums;background:rgba(10,16,40,.92)}
    /* LOGIN */
    .lock{position:fixed;inset:0;background:rgba(11,16,32,.92);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999;backdrop-filter:blur(8px)}
    .lock.show{display:flex}
    .lockCard{
      width:min(520px,100%);background:linear-gradient(180deg, rgba(17,26,51,.9), rgba(13,20,48,.85));
      border:1px solid rgba(34,48,94,.95);border-radius:18px;padding:18px;overflow:hidden;
      box-shadow:0 18px 45px rgba(0,0,0,.35);position:relative;
    }
    .lockCard::before{content:"";position:absolute;inset:-40px -40px auto -40px;height:140px;background:radial-gradient(closest-side, rgba(60,255,160,.12), transparent 70%);opacity:.55;pointer-events:none}
    .lockTitle{font-size:18px;font-weight:900;margin:0 0 8px}
    .lockRow{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .lockHint{font-size:12px;opacity:.8;margin-top:8px}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .topRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .smallBtn{
      padding:8px 10px;border-radius:12px;border:1px solid rgba(58,83,168,.95);
      background:linear-gradient(180deg, rgba(27,42,90,.95), rgba(18,30,70,.95));
      color:var(--ink);cursor:pointer;font-weight:800;font-size:12px;max-width:100%;
      transition:transform .08s, filter .15s;white-space:nowrap;
    }
    .smallBtn:hover{filter:brightness(1.08)} .smallBtn:active{transform:translateY(1px)}
    .smallBtn.green{border-color:rgba(60,255,160,.45);background:linear-gradient(180deg, rgba(14,40,32,.85), rgba(10,24,20,.85))}
    .smallBtn.green:hover{box-shadow:0 0 0 3px rgba(60,255,160,.12)}
    /* Toggle */
    .toggleWrap{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:12px;border:1px solid rgba(58,83,168,.75);background:rgba(13,20,48,.55);user-select:none}
    .toggleWrap .lbl{font-size:12px;font-weight:800;opacity:.9}
    .toggle{width:44px;height:24px;border-radius:999px;border:1px solid rgba(91,124,250,.45);background:rgba(91,124,250,.18);position:relative;cursor:pointer;flex:0 0 auto}
    .toggle::after{content:"";position:absolute;top:50%;left:3px;width:18px;height:18px;border-radius:999px;transform:translateY(-50%);background:rgba(233,238,252,.92);box-shadow:0 6px 14px rgba(0,0,0,.25);transition:left .15s, background .15s}
    .toggle.on{border-color:rgba(60,255,160,.55);background:rgba(60,255,160,.14)}
    .toggle.on::after{left:22px;background:rgba(60,255,160,.92)}
    /* Export shot */
    .exportShot{display:none;margin-top:12px}
    .shotGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width:640px){.shotGrid{grid-template-columns:1fr}}
    .shotCell{background:rgba(13,20,48,.92);border:1px solid rgba(43,58,114,.95);border-radius:14px;padding:12px;position:relative;overflow:hidden}
    .shotCell::after{content:"";position:absolute;inset:-40% -40% auto -40%;height:120px;background:radial-gradient(closest-side, rgba(60,255,160,.10), transparent 70%);opacity:.5;pointer-events:none}
    .shotLabel{font-size:12px;opacity:.8}
    .shotValue{margin-top:4px;font-size:18px;font-weight:900;letter-spacing:.2px;font-variant-numeric:tabular-nums}
    .shotTableWrap{margin-top:12px;overflow:hidden;border:1px solid rgba(43,58,114,.95);border-radius:14px}
    .shotTableWrap table th{position:static}
    /* Quote mode */
    body.quoteMode .grid{grid-template-columns:1fr!important}
    body.quoteMode .quoteHide{display:none!important}
    body.quoteMode .quoteTableGrow{max-height:none!important;height:calc(100vh - 280px);min-height:420px}
    @media (max-width:860px){body.quoteMode .quoteTableGrow{height:calc(100vh - 330px);min-height:380px}}
    body.quoteMode .quoteEntrada{display:block!important}
    body.quoteMode .normalEntrada{display:none!important}
    /* Admin modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);padding:18px}
    .modal.show{display:flex}
    .modalCard{
      width:min(760px,100%);background:linear-gradient(180deg, rgba(17,26,51,.92), rgba(13,20,48,.88));
      border:1px solid rgba(34,48,94,.95);border-radius:18px;padding:16px;box-shadow:0 18px 45px rgba(0,0,0,.35);position:relative;overflow:hidden;
    }
    .modalCard::before{content:"";position:absolute;inset:-40px -40px auto -40px;height:140px;background:radial-gradient(closest-side, rgba(60,255,160,.10), transparent 70%);opacity:.55;pointer-events:none}
    .modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .modalTitle{font-weight:900;font-size:16px;margin:0}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:720px){.twoCol{grid-template-columns:1fr}}
    .miniCard{background:rgba(13,20,48,.92);border:1px solid rgba(43,58,114,.95);border-radius:14px;padding:12px}
    .danger{border-color:rgba(255,120,120,.45)!important}
    .small{font-size:12px;opacity:.8}
    .userList{margin-top:10px;max-height:260px;overflow:auto;border:1px solid rgba(43,58,114,.95);border-radius:12px}
    .userList table th{position:sticky}
    .tagAdmin{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid rgba(60,255,160,.45);background:rgba(60,255,160,.10);font-size:11px;font-weight:900}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div class="lock" id="lock">
    <div class="lockCard">
      <p class="lockTitle">üîí C√ÅLCULO ANTT - PISO M√çNIMO</p>
      <div class="muted">Selecione seu usu√°rio e digite a senha para acessar.</div>
      <div class="lockRow">
        <label for="lockUser">Usu√°rio</label>
        <select id="lockUser"></select>
        <label for="lockPass">Senha</label>
        <input id="lockPass" type="password" placeholder="Senha do usu√°rio" />
        <button class="btn" id="lockBtn">Entrar</button>
        <div class="muted" id="lockMsg" style="color:#ffb3b3; display:none;">Usu√°rio ou senha incorretos.</div>
      </div>
      <div class="lockHint">Acesso somente para Nova Frota</div>
    </div>
  </div>

  <!-- ADMIN MODAL -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <div>
          <p class="modalTitle">üõ† Admin (LUZIANO)</p>
          <div class="muted">Gerencie usu√°rios e senhas (salvo neste navegador).</div>
        </div>
        <button class="smallBtn" id="btnAdminClose">Fechar</button>
      </div>

      <div class="twoCol">
        <div class="miniCard">
          <div class="pill">Criar / Atualizar usu√°rio</div>

          <label for="admUserName">Usu√°rio</label>
          <input id="admUserName" placeholder="Ex: JO√ÉO" />

          <label for="admUserPass">Senha</label>
          <input id="admUserPass" placeholder="Ex: 2026" />

          <button class="btn" id="btnAdminSaveUser">Salvar usu√°rio</button>
          <div class="muted" id="admMsg" style="display:none;"></div>
        </div>

        <div class="miniCard danger">
          <div class="pill">A√ß√µes r√°pidas</div>
          <button class="btn" id="btnAdminResetAllPesos">Resetar pesos de TODOS</button>
          <div class="muted small">Apaga os pesos customizados salvos por usu√°rio neste navegador.</div>
        </div>
      </div>

      <div class="miniCard" style="margin-top:12px;">
        <div class="pill">Usu√°rios cadastrados</div>
        <div class="userList">
          <table>
            <thead>
              <tr>
                <th>Usu√°rio</th>
                <th class="num">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="admUserTable"></tbody>
          </table>
        </div>
        <div class="muted small">Obs: n√£o √© poss√≠vel excluir o usu√°rio LUZIANO.</div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app">
    <div class="card">
      <div class="topbar">
        <div>
          <h1>üöö NOVA FROTA TRANSPORTES E LOGISTICA LTDA</h1>
          <div class="muted">Site exclusivo para Nova Frota - ANTT 6.067/2025 ¬©Ô∏èLuziano Neto.</div>
        </div>

        <div class="topRight">
          <div class="toggleWrap" title="Tabela como principal (cota√ß√£o r√°pida)">
            <span class="lbl">‚ö° Cota√ß√£o R√°pida</span>
            <div class="toggle" id="toggleQuote" role="switch" aria-checked="false" tabindex="0"></div>
          </div>

          <button class="smallBtn" id="btnAdmin" style="display:none">üõ† Admin</button>
          <button class="smallBtn green" id="btnExportCSV" title="Exporta todos os tipos com os valores calculados atuais">‚¨áÔ∏è Exportar CSV</button>
          <button class="smallBtn green" id="btnExportJPG" title="Gera um JPEG com KM/Margem/Ped√°gio/ICMS + Tabela completa">üñºÔ∏è Exportar JPEG</button>
          <span class="pill" id="userBadge">Deslogado</span>
          <button class="smallBtn" id="btnLogout">Sair</button>
        </div>
      </div>

      <div class="exportShot" id="exportShot">
        <div class="pill">Resumo + Tabela (Exporta√ß√£o)</div>
        <div class="shotGrid">
          <div class="shotCell"><div class="shotLabel">KM TOTAL</div><div class="shotValue" id="shotKM">-</div></div>
          <div class="shotCell"><div class="shotLabel">PED√ÅGIO POR EIXO (R$)</div><div class="shotValue" id="shotPed">-</div></div>
          <div class="shotCell"><div class="shotLabel">MARGEM (%)</div><div class="shotValue" id="shotMargem">-</div></div>
          <div class="shotCell"><div class="shotLabel">ICMS (%)</div><div class="shotValue" id="shotICMS">-</div></div>
        </div>
        <div class="shotTableWrap">
          <table>
            <thead><tr><th>Tipo</th><th class="num">Frete Motorista</th><th class="num">Frete Empresa</th></tr></thead>
            <tbody id="shotTable"></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:10px;">Gerado por: <b id="shotUser">-</b></div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <!-- ENTRADA -->
      <div class="card">
        <div class="pill">Entrada</div>

        <div class="normalEntrada">
          <label for="tipo">Tipo</label>
          <select id="tipo"></select>
        </div>

        <div class="quoteEntrada" style="display:none;">
          <div class="muted">Modo cota√ß√£o: selecione o <b>Tipo</b> clicando direto na tabela.</div>
        </div>

        <div class="row">
          <div>
            <label for="km">KM total</label>
            <input id="km" type="number" step="0.1" value="127" />
          </div>
          <div>
            <label for="pedagio">Ped√°gio por eixo (R$)</label>
            <input id="pedagio" type="number" step="0.01" value="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="margem">Margem (%)</label>
            <input id="margem" type="number" step="0.01" value="5" />
          </div>
          <div>
            <label for="icms">ICMS (%) (opcional)</label>
            <input id="icms" type="number" step="0.01" value="0" />
          </div>
        </div>

        <button class="btn quoteHide" id="btnCalc">Calcular</button>

        <div class="kpi quoteHide">
          <div class="k"><div class="t">Frete Motorista (R$)</div><div class="v" id="outMotorista">-</div></div>
          <div class="k"><div class="t">Frete Empresa (R$)</div><div class="v" id="outEmpresa">-</div></div>
        </div>

        <div class="muted quoteHide">
          <b>Motorista:</b> ARREDONDAR.PARA.CIMA(((R$/KM√óKM)+CustoCC+(Ped√°gio/Eixo√óEixos))/Peso;0)<br/>
          <b>Empresa:</b> Motorista/(1-Margem)/(1-ICMS) <span style="opacity:.9">(sem arredondar)</span>
        </div>

        <div class="muted" style="margin-top:10px;">
          Dica: Ative <b>‚ö° Cota√ß√£o R√°pida</b> para usar a tabela como painel principal.
        </div>
      </div>

      <!-- TABELAS -->
      <div class="card">
        <div class="pill">Tabela de Fretes (por tipo)</div>

        <div class="quoteTableGrow" style="overflow:auto; margin-top:10px; border:1px solid rgba(43,58,114,.95); border-radius:12px; max-height: 320px;">
          <table>
            <thead>
              <tr>
                <th>Tipo</th>
                <th class="num">Frete Motorista</th>
                <th class="num">Frete Empresa</th>
                <th class="num">Eixos</th>
              </tr>
            </thead>
            <tbody id="tblFretes"></tbody>
          </table>
        </div>

        <div class="quoteHide">
          <div class="pill" style="margin-top:12px;">Peso m√©dio (edit√°vel)</div>
          <div style="overflow:auto; margin-top:10px; border:1px solid rgba(43,58,114,.95); border-radius:12px; max-height: 260px;">
            <table>
              <thead><tr><th>Tipo</th><th class="num">Peso m√©dio</th></tr></thead>
              <tbody id="tblPesos"></tbody>
            </table>
          </div>

          <div class="muted">
            Os pesos alterados ficam salvos neste navegador (por usu√°rio). Para voltar ao padr√£o:
            <div style="margin-top:8px;"><button class="btn" id="btnResetPesos" style="margin-top:0;">Resetar pesos</button></div>
          </div>

          <div class="pill" style="margin-top:14px;">Dados do Tipo selecionado</div>
          <div class="kpi">
            <div class="k"><div class="t">R$ / KM</div><div class="v" id="outRkm">-</div></div>
            <div class="k"><div class="t">Custo CC</div><div class="v" id="outCC">-</div></div>
            <div class="k"><div class="t">Peso m√©dio (usado)</div><div class="v" id="outPeso">-</div></div>
            <div class="k"><div class="t">Observa√ß√£o</div><div class="v" style="font-size:14px;font-weight:700" id="outObs">-</div></div>
          </div>
          <div class="muted">Clique em uma linha da tabela para selecionar o tipo.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ... SEU JS ORIGINAL CONTINUA AQUI SEM ALTERA√á√ÉO ... */

    /* ‚úÖ ADICIONADO (opcional, mas recomendado):
       quando clicar no "Sair" do SEU c√°lculo, tamb√©m derruba o Login 1 do sistema,
       e manda o usu√°rio para o login geral. */
    window.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("btnLogout");
      if (btn) {
        btn.addEventListener("click", () => {
          // derruba login geral do sistema
          localStorage.removeItem("nf_auth_home");
          // e volta para o login geral
          window.location.href = "./login.html";
        });
      }
    });
  </script>

  <script>
/* ================== USERS (ADMIN) ================== */
const ADMIN_USER = "LUZIANO";
const USERS_DEFAULT = {
  "LUZIANO":"1993",
  "ARIEL":"1987",
  "VALDEMI":"2026",
  "LUIS":"2026",
  "ELIEL":"2026",
  "MATHEUS OS":"2026",
};
const USERS_KEY = "antt_users_v1";
const AUTH_KEY  = "antt_auth_user_v1";

function loadUsers(){
  try{
    const raw = localStorage.getItem(USERS_KEY);
    const u = raw ? JSON.parse(raw) : null;
    const merged = Object.assign({}, USERS_DEFAULT, (u && typeof u === "object" ? u : {}));
    if (!merged[ADMIN_USER]) merged[ADMIN_USER] = USERS_DEFAULT[ADMIN_USER] || "1993";
    return merged;
  }catch(e){
    return Object.assign({}, USERS_DEFAULT);
  }
}
function saveUsers(u){
  localStorage.setItem(USERS_KEY, JSON.stringify(u));
}
let USERS = loadUsers();

function isAdmin(){ return getAuthUser() === ADMIN_USER; }

/* ================== MODO COTA√á√ÉO ================== */
function quoteModeKey(){ const u=getAuthUser()||"DEFAULT"; return `antt_${u}_quote_mode_v1`; }
function isQuoteMode(){ return localStorage.getItem(quoteModeKey())==="1"; }
function setQuoteMode(on){ localStorage.setItem(quoteModeKey(), on?"1":"0"); }
function applyQuoteModeUI(){
  const on = isQuoteMode();
  document.body.classList.toggle("quoteMode", on);
  const t = document.getElementById("toggleQuote");
  if (t){ t.classList.toggle("on", on); t.setAttribute("aria-checked", on?"true":"false"); }
}

/* ================== AUTH ================== */
function getAuthUser(){
  const u = localStorage.getItem(AUTH_KEY);
  return u && USERS[u] ? u : null;
}
function setAuthUser(user){
  if (user) localStorage.setItem(AUTH_KEY, user);
  else localStorage.removeItem(AUTH_KEY);
}

function showLock(show){
  const lock = document.getElementById("lock");
  const app  = document.getElementById("app");
  if (show){
    lock.classList.add("show");
    app.style.display="none";
    document.getElementById("lockPass").value="";
    document.getElementById("lockMsg").style.display="none";
    document.getElementById("lockUser").focus();
  }else{
    lock.classList.remove("show");
    app.style.display="";
  }
}
function updateUserBadge(){
  const u=getAuthUser();
  const el=document.getElementById("userBadge");
  if (el) el.textContent = u ? `Logado: ${u}` : "Deslogado";
  const btnAdmin = document.getElementById("btnAdmin");
  if (btnAdmin) btnAdmin.style.display = (u===ADMIN_USER) ? "" : "none";
}
function getScopePrefix(){ const u=getAuthUser()||"DEFAULT"; return `antt_${u}_`; }

function initAuth(){
  USERS = loadUsers();

  const sel = document.getElementById("lockUser");
  sel.innerHTML="";
  Object.keys(USERS).sort().forEach((name)=>{
    const op=document.createElement("option");
    op.value=name; op.textContent=name;
    sel.appendChild(op);
  });

  if (!getAuthUser()) showLock(true); else showLock(false);

  const btn=document.getElementById("lockBtn");
  const pass=document.getElementById("lockPass");
  const msg=document.getElementById("lockMsg");

  function tryLogin(){
    USERS = loadUsers();
    const user=sel.value;
    const ok = USERS[user] && pass.value === USERS[user];
    msg.style.display = ok ? "none" : "block";
    if (ok){
      setAuthUser(user);
      showLock(false);
      updateUserBadge();
      pesosCustom = loadPesosCustom();
      applyQuoteModeUI();
      calc();
    }
  }

  btn.addEventListener("click", tryLogin);
  pass.addEventListener("keydown",(e)=>{ if (e.key==="Enter") tryLogin(); });

  document.getElementById("btnLogout").addEventListener("click", ()=>{
    setAuthUser(null);
    updateUserBadge();
    showLock(true);
    document.body.classList.remove("quoteMode");
  });

  updateUserBadge();
}

/* ================== DATA ================== */
const DATA = [
  { tipo:"9 Rodotrem",         rkm:8.53,   custoCC:877.83, peso:49 },
  { tipo:"9 Rodoca√ßamba",      rkm:8.53,   custoCC:877.83, peso:47 },
  { tipo:"8 eixos Graneleiro", rkm:7.4505, custoCC:792.30, peso:45 },
  { tipo:"8 eixos Ca√ßamba",    rkm:7.4505, custoCC:792.30, peso:43 },
  { tipo:"4¬∫ eixo Graneleiro", rkm:7.4505, custoCC:792.30, peso:39 },
  { tipo:"4¬∫ eixo Ca√ßamba",    rkm:7.4505, custoCC:792.30, peso:37 },
  { tipo:"7 Bitrem",           rkm:7.4505, custoCC:792.30, peso:37 },
  { tipo:"7 Bi√ßamba",          rkm:7.4505, custoCC:792.30, peso:35 },
  { tipo:"6 LS Graneleiro",    rkm:6.8058, custoCC:656.76, peso:31 },
  { tipo:"6 LS Ca√ßamba",       rkm:6.8058, custoCC:656.76, peso:29 },
  { tipo:"5 LS Graneleiro",    rkm:6.1859, custoCC:642.10, peso:26 },
  { tipo:"5 LS TOCO Ca√ßamba",  rkm:6.1859, custoCC:642.10, peso:25 },
];

const $ = (id)=>document.getElementById(id);
const money=(n)=>n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const numpt=(n,d=4)=>n.toLocaleString("pt-BR",{minimumFractionDigits:d,maximumFractionDigits:d});

function parsePtNumber(value){
  let s=String(value??"").trim().replace(/\s+/g,"");
  if(!s) return NaN;
  s=s.replace(/[^\d.,-]/g,"");
  if(s.includes(",")) s=s.replace(/\./g,"").replace(",",".");
  const n=Number(s);
  return Number.isFinite(n)?n:NaN;
}
function fmtPeso(n){ return Number(n).toLocaleString("pt-BR",{minimumFractionDigits:3,maximumFractionDigits:3}); }
function fillTipos(){
  const sel=$("tipo");
  sel.innerHTML="";
  DATA.forEach((r,idx)=>{
    const op=document.createElement("option");
    op.value=idx; op.textContent=r.tipo;
    sel.appendChild(op);
  });
  sel.value="0";
}
function extrairEixos(tipo){
  const m=String(tipo).trim().match(/^(\d+)/);
  return m?Number(m[1]):0;
}
function ceil0(n){ return Math.ceil(n); }

function bindGlow(el){
  if(!el) return;
  el.addEventListener("focus",()=>el.classList.add("editingGlow"));
  el.addEventListener("blur", ()=>el.classList.remove("editingGlow"));
}

function getInputs(){
  const km=Number($("km").value||0);
  const pedagioPorEixo=Number($("pedagio").value||0);
  const margem=Number($("margem").value||0)/100;
  const icms=Number($("icms").value||0)/100;
  return {km,pedagioPorEixo,margem,icms};
}

/* ================== PESOS POR USU√ÅRIO ================== */
function pesosKey(){ return getScopePrefix()+"pesos_custom_v1"; }
function loadPesosCustom(){
  try{
    const raw=localStorage.getItem(pesosKey());
    const obj=raw?JSON.parse(raw):{};
    return (obj && typeof obj==="object")?obj:{};
  }catch(e){ return {}; }
}
function savePesosCustom(obj){ localStorage.setItem(pesosKey(), JSON.stringify(obj)); }

let pesosCustom={};
let isEditingPeso=false;

function getPeso(row){
  const v=pesosCustom[row.tipo];
  const n=Number(v);
  return (Number.isFinite(n)&&n>0)?n:row.peso;
}
function renderTabelaPesos(){
  const tbody=$("tblPesos");
  if(!tbody) return;
  tbody.innerHTML="";
  const idxSel=Number($("tipo").value);

  DATA.forEach((row,idx)=>{
    const tr=document.createElement("tr");
    tr.className="rowItem"+(idx===idxSel?" active":"");
    const pesoAtual=getPeso(row);
    tr.innerHTML=`
      <td style="white-space:nowrap">${row.tipo}</td>
      <td class="num">
        <input class="pesoInput" data-tipo="${row.tipo}" type="text" inputmode="decimal"
          autocomplete="off" autocapitalize="off" spellcheck="false" value="${fmtPeso(pesoAtual)}" />
      </td>`;
    const input=tr.querySelector("input[data-tipo]");

    input.addEventListener("focus",(ev)=>{
      isEditingPeso=true; input.classList.add("editingGlow");
      requestAnimationFrame(()=>ev.target.select());
    });
    input.addEventListener("input",(ev)=>{
      const tipo=ev.target.getAttribute("data-tipo");
      const val=parsePtNumber(ev.target.value);
      if(Number.isFinite(val)&&val>0) pesosCustom[tipo]=val; else delete pesosCustom[tipo];
      savePesosCustom(pesosCustom);
      calc({skipPesosRender:true});
    });
    input.addEventListener("blur",(ev)=>{
      const tipo=ev.target.getAttribute("data-tipo");
      const val=parsePtNumber(ev.target.value);
      if(Number.isFinite(val)&&val>0){ pesosCustom[tipo]=val; ev.target.value=fmtPeso(val); }
      else{ delete pesosCustom[tipo]; ev.target.value=fmtPeso(getPeso(row)); }
      savePesosCustom(pesosCustom);
      isEditingPeso=false; input.classList.remove("editingGlow");
      calc();
    });

    tbody.appendChild(tr);
  });
}
function resetPesos(){
  pesosCustom={};
  localStorage.removeItem(pesosKey());
  calc();
}

/* reset global (admin) */
function resetAllPesos(){
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k && k.endsWith("_pesos_custom_v1")) keys.push(k);
  }
  keys.forEach(k=>localStorage.removeItem(k));
}

/* ================== C√ÅLCULO ================== */
function calcFretes(row, km, pedagioPorEixo, margem, icms){
  const eixos=extrairEixos(row.tipo);
  const numerador=(row.rkm*km)+row.custoCC+(pedagioPorEixo*eixos);

  const pesoUsado=getPeso(row);
  const base=numerador/pesoUsado;

  const freteMotorista=ceil0(base);

  const denomMargem=(1-margem);
  const denomIcms=(1-icms);

  const freteEmpresa=(denomMargem<=0||denomIcms<=0)?NaN:(freteMotorista/denomMargem/denomIcms);

  return {eixos,pesoUsado,freteMotorista,freteEmpresa,numerador};
}

function renderTabela(km, pedagioPorEixo, margem, icms){
  const tbody=$("tblFretes");
  tbody.innerHTML="";
  const idxSel=Number($("tipo").value);

  DATA.forEach((row,idx)=>{
    const r=calcFretes(row,km,pedagioPorEixo,margem,icms);
    const tr=document.createElement("tr");
    tr.className="rowItem"+(idx===idxSel?" active":"");
    tr.innerHTML=`
      <td style="white-space:nowrap">${row.tipo}</td>
      <td class="num motorCol">${money(r.freteMotorista)}</td>
      <td class="num empresaCol">${Number.isFinite(r.freteEmpresa)?money(r.freteEmpresa):"Erro"}</td>
      <td class="num" style="opacity:.85">${r.eixos}</td>`;
    tr.addEventListener("click", ()=>{
      $("tipo").value=String(idx);
      calc();
    });
    tbody.appendChild(tr);
  });
}

/* ================== EXPORT CSV ================== */
function csvEscape(v){
  const s=String(v??"");
  if(/[;"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function toPt(v,d=3){
  const n=Number(v); if(!Number.isFinite(n)) return "";
  return n.toLocaleString("pt-BR",{minimumFractionDigits:d,maximumFractionDigits:d});
}
function toIntPt(v){
  const n=Number(v); if(!Number.isFinite(n)) return "";
  return n.toLocaleString("pt-BR",{maximumFractionDigits:0});
}
function toMoneyPt(v){
  const n=Number(v); if(!Number.isFinite(n)) return "";
  return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function buildExportRows(){
  const {km,pedagioPorEixo,margem,icms}=getInputs();
  return DATA.map((row)=>{
    const r=calcFretes(row,km,pedagioPorEixo,margem,icms);
    return {
      "Tipo":row.tipo,"Eixos":r.eixos,"KM":km,"Ped√°gio por eixo (R$)":pedagioPorEixo,
      "R$/KM":row.rkm,"Custo CC":row.custoCC,"Peso padr√£o":row.peso,"Peso usado":r.pesoUsado,
      "Motorista (R$)":r.freteMotorista,"Empresa (R$)":r.freteEmpresa,"Margem (%)":margem*100,"ICMS (%)":icms*100,
    };
  });
}
function exportCSV(){
  if(!getAuthUser()) return;
  const rows=buildExportRows();
  const headers=Object.keys(rows[0]||{});
  const lines=[];
  const {km,pedagioPorEixo,margem,icms}=getInputs();
  lines.push(csvEscape("NOVA FROTA - Exporta√ß√£o ANTT 6.067/2025"));
  lines.push(csvEscape(`Usu√°rio: ${getAuthUser()} | KM: ${km} | Ped√°gio/eixo: ${pedagioPorEixo} | Margem: ${(margem*100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}% | ICMS: ${(icms*100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}%`));
  lines.push("");
  lines.push(headers.map(csvEscape).join(";"));
  for(const r of rows){
    lines.push(headers.map((h)=>{
      const v=r[h];
      if(h==="R$/KM") return csvEscape(toPt(v,4));
      if(h==="Custo CC") return csvEscape(toPt(v,2));
      if(h==="Peso padr√£o"||h==="Peso usado") return csvEscape(toPt(v,3));
      if(h==="Motorista (R$)"||h==="Empresa (R$)") return csvEscape(toMoneyPt(v));
      if(h==="Margem (%)"||h==="ICMS (%)") return csvEscape(toPt(v,2));
      if(h==="Eixos") return csvEscape(toIntPt(v));
      if(h==="KM") return csvEscape(toPt(v,1));
      if(h==="Ped√°gio por eixo (R$)") return csvEscape(toPt(v,2));
      return csvEscape(v);
    }).join(";"));
  }
  const csv=lines.join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const d=new Date();
  const stamp=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}_${String(d.getHours()).padStart(2,"0")}${String(d.getMinutes()).padStart(2,"0")}`;
  const filename=`antt_export_${getAuthUser()}_${stamp}.csv`;
  const a=document.createElement("a"); a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1200);
}

/* ================== EXPORT JPEG ================== */
function renderShotTable(){
  const tbody=$("shotTable"); if(!tbody) return;
  tbody.innerHTML="";
  const {km,pedagioPorEixo,margem,icms}=getInputs();
  for(const row of DATA){
    const r=calcFretes(row,km,pedagioPorEixo,margem,icms);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td style="white-space:nowrap">${row.tipo}</td>
      <td class="num motorCol">${money(r.freteMotorista)}</td>
      <td class="num empresaCol">${Number.isFinite(r.freteEmpresa)?money(r.freteEmpresa):"Erro"}</td>`;
    tbody.appendChild(tr);
  }
}
function exportJPG(){
  if(!getAuthUser()) return;
  const shot=$("exportShot");
  const {km,pedagioPorEixo,margem,icms}=getInputs();
  $("shotKM").textContent=km.toLocaleString("pt-BR",{maximumFractionDigits:1});
  $("shotPed").textContent=pedagioPorEixo.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
  $("shotMargem").textContent=(margem*100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
  $("shotICMS").textContent=(icms*100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
  $("shotUser").textContent=getAuthUser();
  renderShotTable();
  shot.style.display="block";
  html2canvas(shot,{backgroundColor:null,scale:2}).then((canvas)=>{
    const d=new Date();
    const stamp=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}_${String(d.getHours()).padStart(2,"0")}${String(d.getMinutes()).padStart(2,"0")}`;
    const filename=`antt_resumo_${getAuthUser()}_${stamp}.jpg`;
    canvas.toBlob((blob)=>{
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),1200);
      shot.style.display="none";
    },"image/jpeg",0.92);
  }).catch(()=>{
    shot.style.display="none";
    alert("N√£o consegui gerar a imagem. Se estiver offline, o html2canvas n√£o carrega.");
  });
}

/* ================== CALC ================== */
function calc(opts={}){
  if(!getAuthUser()) return;
  const row=DATA[Number($("tipo").value)];
  const {km,pedagioPorEixo,margem,icms}=getInputs();
  const {eixos,pesoUsado,freteMotorista,freteEmpresa}=calcFretes(row,km,pedagioPorEixo,margem,icms);

  if($("outRkm")) $("outRkm").textContent="R$ "+numpt(row.rkm,4);
  if($("outCC")) $("outCC").textContent="R$ "+numpt(row.custoCC,3);
  if($("outPeso")) $("outPeso").textContent=fmtPeso(pesoUsado);
  if($("outObs")) $("outObs").textContent=`${row.tipo} | Eixos: ${eixos}`;
  if($("outMotorista")) $("outMotorista").textContent=money(freteMotorista);
  if($("outEmpresa")) $("outEmpresa").textContent=Number.isFinite(freteEmpresa)?money(freteEmpresa):"Erro (margem/ICMS 100%)";

  renderTabela(km,pedagioPorEixo,margem,icms);

  if(!opts.skipPesosRender && !isEditingPeso) renderTabelaPesos();
}

/* ================== ADMIN UI ================== */
function showAdmin(show){
  const m=$("adminModal");
  if(!m) return;
  m.classList.toggle("show", !!show);
  m.setAttribute("aria-hidden", show ? "false" : "true");
  if(show) renderAdminUsers();
}
function renderAdminUsers(){
  USERS = loadUsers();
  const tbody=$("admUserTable");
  tbody.innerHTML="";
  Object.keys(USERS).sort().forEach((u)=>{
    const tr=document.createElement("tr");
    const isAdm = (u===ADMIN_USER);
    tr.innerHTML=`
      <td style="white-space:nowrap">${u}${isAdm?`<span class="tagAdmin">ADMIN</span>`:""}</td>
      <td class="num">
        ${isAdm?`<span class="muted">---</span>`:`<button class="smallBtn" data-del="${u}">Excluir</button>`}
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-del]").forEach((b)=>{
    b.addEventListener("click", ()=>{
      const u=b.getAttribute("data-del");
      if(!u || u===ADMIN_USER) return;
      if(confirm(`Excluir o usu√°rio ${u}?`)){
        USERS = loadUsers();
        delete USERS[u];
        saveUsers(USERS);
        initAuth(); // repopula select login
        renderAdminUsers();
        toastAdmin("Usu√°rio exclu√≠do.", true);
      }
    });
  });
}
function toastAdmin(txt, ok){
  const el=$("admMsg");
  if(!el) return;
  el.style.display="block";
  el.style.color = ok ? "#b7ffd7" : "#ffb3b3";
  el.textContent = txt;
  setTimeout(()=>{ el.style.display="none"; }, 2200);
}

/* ================== INIT ================== */
initAuth();
fillTipos();

const btnReset=$("btnResetPesos");
if(btnReset) btnReset.addEventListener("click", resetPesos);

const btnCalc=$("btnCalc");
if(btnCalc) btnCalc.addEventListener("click", ()=>calc());

$("tipo").addEventListener("change", ()=>calc());
["km","pedagio","margem","icms"].forEach(id=>$(id).addEventListener("input", ()=>calc()));

["km","pedagio","margem","icms","tipo","lockPass","lockUser","admUserName","admUserPass"].forEach(id=>bindGlow($(id)));

$("btnExportCSV").addEventListener("click", exportCSV);
$("btnExportJPG").addEventListener("click", exportJPG);

/* Toggle cota√ß√£o */
const tgl=$("toggleQuote");
function toggleQuote(){
  if(!getAuthUser()) return;
  const next=!isQuoteMode();
  setQuoteMode(next);
  applyQuoteModeUI();
  calc();
}
tgl.addEventListener("click", toggleQuote);
tgl.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleQuote(); }
});

/* Admin bind */
$("btnAdminClose").addEventListener("click", ()=>showAdmin(false));
$("adminModal").addEventListener("click",(e)=>{ if(e.target && e.target.id==="adminModal") showAdmin(false); });

$("btnAdmin").addEventListener("click", ()=>{
  if(!isAdmin()) return;
  showAdmin(true);
});

$("btnAdminSaveUser").addEventListener("click", ()=>{
  if(!isAdmin()) return;
  let u = String($("admUserName").value||"").trim().toUpperCase();
  const p = String($("admUserPass").value||"").trim();
  if(!u) return toastAdmin("Informe o nome do usu√°rio.", false);
  if(!p) return toastAdmin("Informe a senha.", false);
  // sanitiza
  u = u.replace(/\s+/g," ").replace(/[^\w√Ä-√ø ]/g,"").trim();
  USERS = loadUsers();
  USERS[u]=p;
  if(!USERS[ADMIN_USER]) USERS[ADMIN_USER]=USERS_DEFAULT[ADMIN_USER]||"1993";
  saveUsers(USERS);
  initAuth();
  renderAdminUsers();
  $("admUserName").value=""; $("admUserPass").value="";
  toastAdmin("Usu√°rio salvo/atualizado.", true);
});

$("btnAdminResetAllPesos").addEventListener("click", ()=>{
  if(!isAdmin()) return;
  if(confirm("Resetar os pesos customizados de TODOS os usu√°rios neste navegador?")){
    resetAllPesos();
    pesosCustom = loadPesosCustom();
    calc();
    toastAdmin("Pesos resetados (todos).", true);
  }
});

/* boot */
if(getAuthUser()){
  pesosCustom=loadPesosCustom();
  applyQuoteModeUI();
  calc();
}
</script>

</body>
</html>
