<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fretes | NOVA FROTA</title>
  <link rel="stylesheet" href="../assets/css/app.css" />

  <!-- Fretes: layout mais "planilha" + tema claro somente nesta p√°gina -->
  <style>
    /* ====== BASE (densidade / planilha) ====== */
    .container{max-width:1400px}
    .card{padding:14px; overflow:hidden}
    .tableWrap{
      overflow:auto;
      border:1px solid rgba(43,58,114,.35);
      border-radius:14px;
      height: calc(100vh - 300px);
      min-height: 420px;
      background:#fff;
    }
    @media (max-width:1100px){
      .tableWrap{height:auto; min-height:360px;}
    }
    table{width:100%; border-collapse:collapse; min-width:1400px; background:#fff;}
    th,td{
      padding:6px 10px;
      border-bottom:1px solid #D1D5DB;
      font-size:12px;
      vertical-align:middle;
      white-space:nowrap;
      color:#111827;
    }
    thead th{
      position:sticky; top:0; z-index:3;
      background:#0F172A;
      color:#fff;
      border-bottom:1px solid #0B1220;
      font-size:11px;
      letter-spacing:.02em;
    }
    tbody tr:nth-child(even){background:#F1F4F9;}
    tbody tr:hover{background:#E8EDFF;}
    .rowSlim td{padding-top:5px; padding-bottom:5px;}

    .groupRow td{
      position:sticky; top:34px; z-index:2;
      background:#0B1220;
      color:#fff;
      font-weight:900;
      letter-spacing:.04em;
      border-bottom:1px solid rgba(60,255,160,.18);
    }

    /* pills */
    .pillYN{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:22px; border-radius:999px; font-weight:900; font-size:12px;
      border:1px solid rgba(17,24,39,.18);
    }
    .pillYN.yes{background:#DCFCE7; border-color:#86EFAC; color:#166534;}
    .pillYN.no{background:#FEE2E2; border-color:#FCA5A5; color:#7F1D1D;}

    .statusPill{
      display:inline-flex; align-items:center;
      padding:4px 10px; border-radius:999px; font-weight:900; font-size:11px;
      border:1px solid rgba(17,24,39,.18);
      color:#111827;
    }
    .statusPill.liberado{background:#E6F6ED; border-color:#A7F3D0; color:#067647;}
    .statusPill.parado{background:#FFF4E5; border-color:#FCD34D; color:#92400E;}
    .statusPill.suspenso{background:#FDECEC; border-color:#FCA5A5; color:#991B1B;}

    .muted2{color: rgba(17,24,39,.70);}
    .note{font-size:12px; line-height:1.35;}

    /* ====== LAYOUT (top + tabela em tela inteira) ====== */
    .container.nfWide{max-width: 1650px;}
    .container.pageFretes{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:calc(100vh - 72px);
      padding-bottom:18px;
      background:#F5F7FA;
    }

    .card.tableFull{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:380px;
      background:#FFFFFF;
      border:1px solid #E5E7EB;
      box-shadow:0 4px 12px rgba(0,0,0,.04);
      border-radius:18px;
    }
    .card.tableFull .tableWrap{
      flex:1 1 auto;
      max-height:none !important;
      height:auto !important;
    }

    /* ====== TOP minimalista ====== */
    .fretes-top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding:12px 14px;
      background:#FFFFFF;
      border:1px solid #E5E7EB;
      border-radius:18px;
      box-shadow:0 4px 12px rgba(0,0,0,.04);
    }
    .fretes-top .title{display:flex; flex-direction:column; gap:4px;}
    .fretes-top .title h1{
      margin:0;
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
      color:#0F172A;
    }
    .fretes-top .title .sub{
      font-size:12px;
      color: rgba(17,24,39,.70);
      max-width: 980px;
    }

    /* ====== toolbar compacta ====== */
    .fretes-toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid #E5E7EB;
      background:#FFFFFF;
      box-shadow:0 4px 12px rgba(0,0,0,.04);
    }
    .ft-block{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .ft-spacer{flex:1 1 auto; min-width:10px}
    .ft-label{
      font-size:11px;
      font-weight:900;
      opacity:.9;
      color:#0F172A;
      margin-right:2px;
    }
    .ft-mini{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:900;
      color:#0F172A;
      opacity:.95;
    }
    .ft-mini input{
      width:66px;
      height:32px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #D1D5DB;
      background:#FFFFFF;
      color:#111827;
      outline:none;
    }
    .ft-mini input:focus{
      border-color:#5B7CFA;
      box-shadow:0 0 0 3px rgba(91,124,250,.18);
    }
    .ft-select, .ft-search{
      height:32px;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid #D1D5DB;
      background:#FFFFFF;
      color:#111827;
      outline:none;
    }
    .ft-select{width:200px}
    .ft-search{width:min(380px, 55vw)}
    @media (max-width:700px){
      .ft-select,.ft-search{width:100%}
    }

    .btnTiny{
      height:32px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.14);
      background:#0F172A;
      color:#FFFFFF;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .btnTiny:hover{filter:brightness(1.06)}
    .btnTiny.green{background:#0B3B2E; border-color:rgba(6,118,71,.25)}
    .btnTiny.ghost{
      background:#FFFFFF;
      color:#0F172A;
      border:1px solid #D1D5DB;
    }

    /* util */
    .num{text-align:right;}

    /* ====== MODAL (minimalista + alinhado) ====== */
    .modalOverlay{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      backdrop-filter: blur(6px);
      z-index:9999;
      padding:18px;
      align-items:center;
      justify-content:center;
    }
    .modalCard{
      width:min(920px, 100%);
      max-height: calc(100vh - 40px);
      overflow:auto;
      background:#fff;
      border:1px solid #E5E7EB;
      border-radius:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.18);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px 10px;
      border-bottom:1px solid #EEF2F7;
      position:sticky;
      top:0;
      background:#fff;
      z-index:2;
    }
    .modalHeader .hTitle{display:flex; flex-direction:column; gap:2px;}
    .modalHeader .hTitle .t{font-weight:950; font-size:15px; color:#0F172A;}
    .modalHeader .hTitle .s{font-size:12px; color:rgba(17,24,39,.65);}

    .modalBody{padding:12px 14px 14px;}
    .sectionRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:10px 0 8px;
    }
    .sectionRow .sec{
      font-size:11px;
      font-weight:950;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#0F172A;
      opacity:.9;
    }
    .divider{height:1px; background:#EEF2F7; margin:10px 0;}

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:820px){
      .formGrid{grid-template-columns:1fr;}
    }
    .formGroup label{
      display:block;
      font-size:11px;
      font-weight:900;
      color:rgba(15,23,42,.88);
      margin:0 0 6px;
    }
    .formGroup input, .formGroup select{
      width:100%;
      height:36px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #D1D5DB;
      background:#fff;
      color:#111827;
      outline:none;
    }
    .formGroup input:focus, .formGroup select:focus{
      border-color:#5B7CFA;
      box-shadow:0 0 0 3px rgba(91,124,250,.18);
    }
    .formGroup .hint{
      margin-top:6px;
      font-size:11px;
      color:rgba(17,24,39,.62);
      line-height:1.25;
    }
    .span2{grid-column:1/-1;}

    .modalFooter{
      display:flex;
      gap:10px;
      padding:12px 14px 14px;
      border-top:1px solid #EEF2F7;
      position:sticky;
      bottom:0;
      background:#fff;
    }
    .modalFooter .sp{flex:1 1 auto;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <a class="burger" href="./home.html" title="Voltar"><div></div></a>
        <img src="../assets/img/logo-novafrota.png" alt="NOVA FROTA" />
      </div>
      <div class="actions">
        <div class="icon-btn" title="Sair" data-logout>üë§</div>
      </div>
    </div>
  </div>

  <!-- OBS: fundo claro apenas aqui -->
  <div class="container nfWide pageFretes" style="padding-top:18px;">
    <!-- T√çTULO (minimal) -->
    <div class="card fretes-top">
      <div class="title">
        <h1>Fretes (Operacional)</h1>
        <div class="sub">Permiss√£o Frete M√≠nimo: indica quais tipos (eixos) atendem o piso m√≠nimo ANTT por embarque.</div>
      </div>
    </div>

    <!-- BARRA COMPACTA -->
    <div class="fretes-toolbar">
      <div class="ft-block">
        <span class="ft-label">Pesos:</span>

        <div class="ft-mini"><span>9E</span><input id="w9" type="number" step="0.01" value="47" /></div>
        <div class="ft-mini"><span>4E</span><input id="w4" type="number" step="0.01" value="39" /></div>
        <div class="ft-mini"><span>7E</span><input id="w7" type="number" step="0.01" value="36" /></div>
        <div class="ft-mini"><span>6E</span><input id="w6" type="number" step="0.01" value="31" /></div>

        <button class="btnTiny" id="btnSaveWeights">Salvar</button>
        <button class="btnTiny ghost" id="btnResetWeights">Reset</button>
        <button
  type="button"
  class="btnTiny ghost"
  onclick="window.location.href='./share-clientes.html'">
  Share Clientes
</button>

      </div>

      <div class="ft-spacer"></div>

      <div class="ft-block">
        <select class="ft-select" id="fFilial" title="Filial"></select>
        <input class="ft-search" id="fBusca" placeholder="Buscar (cliente, origem, destino, produto, contato)..." />
        <button class="btnTiny green" id="btnNew">+ Novo</button>
        <button class="btnTiny red" id="btnResetExample"title="Restaura o exemplo local">Exemplo</button>
        </div>
    </div>

    <!-- TABELA -->
    <div class="card tableFull">
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Regional</th>
              <th>Filial</th>
              <th>Cliente</th>
              <th>Origem</th>
              <th>Coleta</th>
              <th>Contato</th>
              <th>Destino</th>
              <th>UF</th>
              <th>Descarga</th>
              <th class="num">Volume</th>
              <th class="num">Vlr Empresa</th>
              <th class="num">Vlr Motorista</th>
              <th class="num">KM</th>
              <th class="num">Ped√°gio/Eixo</th>

              <th class="num">5E</th>
              <th class="num">6E</th>
              <th class="num">7E</th>
              <th class="num">4E</th>
              <th class="num">9E</th>

              <th>Produto</th>
              <th>ICMS</th>
              <th class="num">Pedido SAT</th>
              <th class="num">Qtd Porta</th>
              <th class="num">Qtd Tr√¢nsito</th>
              <th>Status</th>
              <th>Observa√ß√µes</th>
              <th class="num">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal (novo/editar) - minimal, alinhado e menor -->
  <div id="modal" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <div class="hTitle">
          <div class="t" id="modalTitle">Frete</div>
          <div class="s">Preencha os dados do embarque. <b>Contato</b> √© fixo (igual planilha).</div>
        </div>
        <button class="btnTiny ghost" id="btnCloseModal">Fechar</button>
      </div>

      <div class="modalBody">
        <div class="sectionRow"><div class="sec">Identifica√ß√£o</div></div>
        <div class="formGrid">
          <div class="formGroup">
            <label for="mRegional">Regional</label>
            <input id="mRegional" placeholder="Ex: GOI√ÅS" />
          </div>
          <div class="formGroup">
            <label for="mFilial">Filial</label>
            <select id="mFilial"></select>
          </div>

          <div class="formGroup">
            <label for="mCliente">Cliente</label>
            <input id="mCliente" placeholder="Ex: CARGILL" />
          </div>
          <div class="formGroup">
            <label for="mContato">Contato de embarque</label>
            <select id="mContato"></select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="sectionRow"><div class="sec">Rota</div></div>
        <div class="formGrid">
          <div class="formGroup">
            <label for="mOrigem">Origem</label>
            <input id="mOrigem" placeholder="Ex: RIO VERDE-GO" />
          </div>
          <div class="formGroup">
            <label for="mColeta">Coleta</label>
            <input id="mColeta" placeholder="Ex: FAZ SANTANA" />
          </div>

          <div class="formGroup">
            <label for="mDestino">Destino</label>
            <input id="mDestino" placeholder="Ex: SANTOS/SP" />
          </div>
          <div class="formGroup">
            <label for="mUF">UF</label>
            <input id="mUF" placeholder="Ex: GO" />
          </div>

          <div class="formGroup span2">
            <label for="mDescarga">Descarga</label>
            <input id="mDescarga" placeholder="Ex: CARGILL" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="sectionRow"><div class="sec">Valores e par√¢metros</div></div>
        <div class="formGrid">
          <div class="formGroup">
            <label for="mKM">KM</label>
            <input id="mKM" type="number" step="0.1" placeholder="Ex: 330" />
          </div>
          <div class="formGroup">
            <label for="mPed">Ped√°gio por eixo (R$)</label>
            <input id="mPed" type="number" step="0.01" placeholder="Ex: 7.40" />
            <div class="hint">Usado no c√°lculo da Permiss√£o Frete M√≠nimo (5E/6E/7E/4E/9E).</div>
          </div>

          <div class="formGroup">
            <label for="mVolume">Volume</label>
            <input id="mVolume" type="number" step="0.01" placeholder="Ex: 75" />
          </div>
          <div class="formGroup">
            <label for="mEmpresa">Valor Empresa (R$)</label>
            <input id="mEmpresa" type="number" step="0.01" placeholder="Ex: 87" />
          </div>

          <div class="formGroup">
            <label for="mMotorista">Valor Motorista (R$)</label>
            <input id="mMotorista" type="number" step="0.01" placeholder="Ex: 80" />
          </div>
          <div class="formGroup">
            <label for="mProduto">Produto</label>
            <input id="mProduto" placeholder="Ex: SOJA" />
          </div>

          <div class="formGroup">
            <label for="mICMS">ICMS</label>
            <input id="mICMS" placeholder="Ex: ISENTO (CIF)" />
          </div>
          <div class="formGroup">
            <label for="mSat">Pedido SAT</label>
            <input id="mSat" type="number" step="1" placeholder="Ex: 12245" />
          </div>

          <div class="formGroup">
            <label for="mPorta">Qtd Porta</label>
            <input id="mPorta" type="number" step="1" placeholder="Ex: 2" />
          </div>
          <div class="formGroup">
            <label for="mTransito">Qtd Tr√¢nsito</label>
            <input id="mTransito" type="number" step="1" placeholder="Ex: 3" />
          </div>

          <div class="formGroup">
            <label for="mStatus">Status</label>
            <select id="mStatus">
              <option value="LIBERADO">LIBERADO</option>
              <option value="PARADO">PARADO</option>
              <option value="SUSPENSO">SUSPENSO</option>
            </select>
          </div>

          <div class="formGroup span2">
            <label for="mObs">Observa√ß√µes</label>
            <input id="mObs" placeholder="Ex: AGENDAMENTO ALONGADO" />
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btnTiny green" id="btnSave">Salvar</button>
        <button class="btnTiny ghost" id="btnCancel">Cancelar</button>
        <div class="sp"></div>
      </div>
    </div>
  </div>

  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/fretes.js"></script>
  <script>
    requireHomeAuth();
    bindLogoutButton();
  </script>
  <script>
/* =========================================================
   RESET DI√ÅRIO (19:00) - ZERA QTD PORTA / QTD TR√ÇNSITO
   Base: localStorage "nf_fretes_rows_v1"
   ========================================================= */
(function(){
  const STORAGE_KEY = 'nf_fretes_rows_v1';
  const RESET_MARK  = 'nf_qtd_reset_ymd'; // evita rodar 2x no mesmo dia
  const RESET_HOUR  = 19; // 19:00

  function ymd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function safeParseJSON(raw){
    try{
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    }catch(e){
      return [];
    }
  }

  // aceita varia√ß√µes de nomes (caso seu fretes.js use outro padr√£o)
  function wipeRowQtd(row){
    if(!row || typeof row !== 'object') return row;

    const candidatesPorta = ['qtdPorta','Qtd Porta','qtd_porta','porta','qtdPortas','qtdporta'];
    const candidatesTrans = ['qtdTransito','Qtd Tr√¢nsito','qtd_transito','transito','qtdTrans','qtdtr√¢nsito','qtdtransito'];

    // limpa (igual ao clearContent do Sheets -> fica vazio)
    candidatesPorta.forEach(k => { if(k in row) row[k] = ''; });
    candidatesTrans.forEach(k => { if(k in row) row[k] = ''; });

    // tamb√©m tenta achar chaves parecidas (case-insensitive)
    const norm = (s)=>String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const keys = Object.keys(row);

    keys.forEach(k=>{
      const nk = norm(k);
      if(['qtdporta','qtdportas','porta'].includes(nk)) row[k] = '';
      if(['qtdtransito','qtdtrans','transito','qtdtrnsito'].includes(nk)) row[k] = '';
    });

    return row;
  }

  function doDailyReset(){
    const today = ymd(new Date());
    const already = localStorage.getItem(RESET_MARK);

    if(already === today) return false; // j√° rodou hoje

    const rows = safeParseJSON(localStorage.getItem(STORAGE_KEY));
    if(!rows.length){
      localStorage.setItem(RESET_MARK, today);
      return true;
    }

    const newRows = rows.map(r => wipeRowQtd({ ...r }));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(newRows));
    localStorage.setItem(RESET_MARK, today);

    // Recarrega pra refletir na tabela (sem depender do fretes.js ter uma fun√ß√£o p√∫blica)
    location.reload();
    return true;
  }

  function scheduleNextRun(){
    const now = new Date();
    const next = new Date(now);
    next.setHours(RESET_HOUR, 0, 0, 0);

    // se j√° passou das 19:00 hoje, agenda para amanh√£
    if(next.getTime() <= now.getTime()){
      next.setDate(next.getDate() + 1);
    }

    const ms = next.getTime() - now.getTime();
    setTimeout(function(){
      doDailyReset();
      scheduleNextRun(); // agenda o pr√≥ximo dia
    }, ms);
  }

  // 1) Se abriu depois das 19h e ainda n√£o rodou hoje -> roda
  (function runIfNeededOnLoad(){
    const now = new Date();
    const today = ymd(now);
    const already = localStorage.getItem(RESET_MARK);

    if(now.getHours() >= RESET_HOUR && already !== today){
      doDailyReset();
      return;
    }
  })();

  // 2) Agenda o reset para a pr√≥xima 19h enquanto a p√°gina estiver aberta
  scheduleNextRun();
})();
</script>
</body>
</html>
