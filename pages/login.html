<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login | NOVA FROTA</title>
  <link rel="stylesheet" href="../assets/css/app.css" />

  <style>
    /* ===== Modal Seletor de Estado ===== */
    .stateOverlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
      z-index: 9999;
    }
    .stateCard{
      width: min(520px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(8,12,24,.62);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow: hidden;
    }
    .stateHead{
      padding: 14px 14px 10px;
      color: #EAF0FF;
      font-weight: 900;
      text-align: center;
      font-size: 18px;
    }
    .stateSub{
      margin-top: 4px;
      font-weight: 600;
      opacity: .75;
      font-size: 12px;
    }

    .stateGrid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 12px 14px 14px;
    }
    @media (max-width:420px){
      .stateGrid{ grid-template-columns: 1fr; }
    }

    .stateBtn{
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 14px 12px;
      color: #fff;
      font-weight: 950;
      cursor: pointer;
      text-align: left;
      background: rgba(255,255,255,.08);
      transition: transform .06s ease, filter .12s ease;
      user-select: none;
    }
    .stateBtn:hover{ filter: brightness(1.05); }
    .stateBtn:active{ transform: scale(.99); }

    .stateBtn .uf{
      font-weight: 800;
      opacity: .85;
      font-size: 12px;
      margin-left: 6px;
    }

    /* cores/transparência (no padrão que você quer) */
    .c-go{ background: rgba(28,175,96,.30); }
    .c-mt{ background: rgba(197,110,45,.30); }
    .c-mg{ background: rgba(210,64,95,.30); }
    .c-sp{ background: rgba(62,110,245,.30); }
    .c-pr{ background: rgba(210,170,40,.30); }
    .c-sc{ background: rgba(160,90,210,.30); }
    .c-to{ background: rgba(40,190,190,.30); }
    .c-ma{ background: rgba(65,90,210,.30); }
    .c-ba{ background: rgba(40,190,140,.30); }

    .stateFoot{
      padding: 0 14px 14px;
      display: flex;
      gap: 10px;
    }
    .stateCancel{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color: #fff;
      font-weight: 900;
      height: 44px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="login-wrap">
    <div class="login-card">
      <div class="head">
        <img src="../assets/img/logo-novafrota.png" alt="NOVA FROTA" />
        <div>
          <div style="font-weight:900; font-size:16px">Sistema Operacional</div>
          <div style="font-size:12px; color: rgba(233,238,252,.75)">Acesso restrito</div>
        </div>
      </div>

      <label class="label" for="user">Usuário</label>
      <input class="input" id="user" placeholder="Ex.: LUZIANO" autocomplete="username" />

      <label class="label" for="pass">Senha</label>
      <input class="input" id="pass" type="password" placeholder="Digite a senha" autocomplete="current-password" />

      <button class="btn" id="btnLogin">Entrar</button>

      <div class="err" id="err">Usuário ou senha inválidos.</div>
      <div class="small">Dedicado - NOVA FROTA ✅</div>
    </div>
  </div>

  <!-- ✅ MODAL: Seleção de Estado -->
  <div class="stateOverlay" id="stateOverlay" aria-hidden="true">
    <div class="stateCard">
      <div class="stateHead">
        Selecionar Estado
        <div class="stateSub" id="stateSub">Escolha o estado liberado para seu usuário</div>
      </div>

      <div class="stateGrid" id="stateGrid"></div>

      <div class="stateFoot">
        <button class="stateCancel" id="btnCancelState">Cancelar</button>
      </div>
    </div>
  </div>

  <script src="../assets/js/auth.js"></script>
  <script>
    // Se já estiver logado e com estado, manda para Home
    if(localStorage.getItem("nf_auth_home") === "1" && localStorage.getItem("nf_auth_state")){
      window.location.href = "./home.html";
    }

    const btn = document.getElementById("btnLogin");
    const err = document.getElementById("err");

    const overlay = document.getElementById("stateOverlay");
    const grid = document.getElementById("stateGrid");
    const btnCancelState = document.getElementById("btnCancelState");

    // nomes/cores dos estados
    const STATES_UI = {
      GO: { name: "Goiás", className: "c-go" },
      MT: { name: "Mato Grosso", className: "c-mt" },
      MG: { name: "Minas Gerais", className: "c-mg" },
      SP: { name: "São Paulo", className: "c-sp" },
      PR: { name: "Paraná", className: "c-pr" },
      SC: { name: "Santa Catarina", className: "c-sc" },
      TO: { name: "Tocantins", className: "c-to" },
      MA: { name: "Maranhão", className: "c-ma" },
      BA: { name: "Bahia", className: "c-ba" },
    };

    function openStateModal(statesAllowed){
      grid.innerHTML = "";

      statesAllowed.forEach((uf) => {
        const info = STATES_UI[uf] || { name: uf, className: "" };

        const b = document.createElement("button");
        b.type = "button";
        b.className = "stateBtn " + (info.className || "");
        b.innerHTML = `${info.name} <span class="uf">${uf}</span>`;

        b.addEventListener("click", () => {
          setSelectedState(uf);
          window.location.href = "./home.html";
        });

        grid.appendChild(b);
      });

      overlay.style.display = "flex";
      overlay.setAttribute("aria-hidden", "false");
    }

    function closeStateModal(){
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden", "true");
    }

    btnCancelState.addEventListener("click", () => {
      // se cancelou, desloga tudo
      logoutAll();
      closeStateModal();
    });

    function doLogin(){
      err.style.display = "none";
      const u = document.getElementById("user").value.trim();
      const p = document.getElementById("pass").value.trim();

      const r = validateLogin(u, p);

      if(!r.ok){
        err.style.display = "block";
        return;
      }

      // ✅ login OK
      setAuthHome(true);
      setUser(r.user);

      // abre modal com estados liberados
      openStateModal(r.states || []);
    }

    btn.addEventListener("click", doLogin);
    document.getElementById("pass").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") doLogin();
    });
  </script>
</body>
</html>
